# ------------------------------------------------------------
# CISRE - Provider-agnostic model configuration
# ------------------------------------------------------------

# Global fallback for visual models
VLM_PROVIDER=google
VLM_MODEL_NAME=gemini-2.5-flash-lite
LLM_TEMPERATURE=0.0

# Optional overrides for ingestion (vision extraction)
# If you set these, they override VLM_* only for ingestion.
# Leave commented to inherit the global provider/model.
# INGEST_VLM_PROVIDER=google
# INGEST_VLM_MODEL_NAME=gemini-2.5-flash-lite
# Optional soft fallback (used only on technical parse failures)
# Set empty to disable escalation.
# INGEST_VLM_FALLBACK_MODEL_NAME=gemini-2.5-flash-lite
# INGEST_VLM_TEMPERATURE=0.0

# Optional overrides for chat (reasoning)
CHAT_LLM_PROVIDER=openai
CHAT_LLM_MODEL_NAME=gpt-4o-mini
CHAT_LLM_TEMPERATURE=0.1

# Provider credentials (set only the ones you use)
GEMINI_API_KEY=
# Alternatively supported for Google: GOOGLE_GENERATIVE_AI_API_KEY=
OPENAI_API_KEY=

# Storage target for batch file uploads
RAG_STORAGE_BUCKET=private_assets

# Runtime environment guardrails
# local: allows LOCAL or CLOUD embedding mode
# staging/production: LOCAL is blocked and forced to CLOUD
APP_ENV=local
RAG_SERVICE_SECRET=development-secret
JINA_MODE=CLOUD
EMBEDDING_PROVIDER_DEFAULT=jina
# Optional ingestion override; if empty, uses EMBEDDING_PROVIDER_DEFAULT
# INGEST_EMBED_PROVIDER_DEFAULT=cohere
INGEST_EMBED_FALLBACK_PROVIDER=jina
INGEST_EMBED_FALLBACK_ON_TECHNICAL_ERROR=true
EMBEDDING_PROVIDER_ALLOWLIST=jina,cohere
COHERE_API_KEY=
COHERE_EMBED_URL=https://api.cohere.com/v2/embed
COHERE_EMBED_MODEL=embed-multilingual-v3.0
COHERE_EMBEDDING_DIMENSIONS=1024
COHERE_REQUEST_MAX_PARALLEL=2
COHERE_MAX_TEXTS_PER_REQUEST=96

# Backend data access
SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=

# Ingestion parser mode
# local: pymupdf4llm/fitz
# cloud: tries Jina Reader URL template, then falls back to local
INGEST_PARSER_MODE=local
# Optional template for cloud reader. Example:
# JINA_READER_URL_TEMPLATE=https://r.jina.ai/http://my-host/{path}
JINA_READER_URL_TEMPLATE=

# Reranking mode
# local: GravityReranker only
# jina: Jina reranker only
# hybrid: Jina + Gravity
RERANK_MODE=hybrid

# Authority classifier mode
# rules: rule-based classifier
# embedding_first: lightweight hashed-embedding classifier then rules fallback
AUTHORITY_CLASSIFIER_MODE=rules

# Query decomposition and branch fan-out controls
QUERY_DECOMPOSER_MAX_SUBQUERIES=4
QUERY_DECOMPOSER_MULTIHOP_TOLERANCE=0.55
RETRIEVAL_PLAN_MAX_BRANCH_EXPANSIONS=2
RETRIEVAL_PLAN_EARLY_EXIT_SCOPE_PENALTY=0.8
RETRIEVAL_MULTI_QUERY_SUBQUERY_RERANK_ENABLED=false
RETRIEVAL_MULTI_QUERY_DROP_SCOPE_PENALIZED_BRANCHES=true
RETRIEVAL_MULTI_QUERY_SCOPE_PENALTY_DROP_THRESHOLD=0.95
ATOMIC_CLAUSE_QUERY_WEIGHT_BOOST_ENABLED=true
ATOMIC_CLAUSE_QUERY_RRF_VECTOR_WEIGHT=0.55
ATOMIC_CLAUSE_QUERY_RRF_FTS_WEIGHT=0.75

# Visual routing cost guard (reduce latency/cost while stabilizing)
VISUAL_ROUTER_MAX_VISUAL_RATIO=0.35
VISUAL_ROUTER_MAX_VISUAL_PAGES=12
VISUAL_PIPELINE_MAX_PARALLEL=3
VISUAL_MIN_IMAGE_BYTES=16384
VISUAL_MIN_IMAGE_WIDTH=200
VISUAL_MIN_IMAGE_HEIGHT=200
VISUAL_DEDUP_IN_DOCUMENT=true

# Chunk persistence throughput
CONTENT_CHUNKS_INSERT_BATCH_SIZE=100
CONTENT_CHUNKS_INSERT_BATCH_SLEEP_SECONDS=0.0

# Worker resilience for transient Supabase/PostgREST transport errors
WORKER_SUPABASE_TRANSIENT_MAX_RETRIES=3
WORKER_SUPABASE_TRANSIENT_BASE_DELAY_SECONDS=0.4
WORKER_SUPABASE_ERROR_COOLDOWN_THRESHOLD=4
WORKER_SUPABASE_ERROR_COOLDOWN_SECONDS=6.0
WORKER_SOURCE_LOOKUP_MAX_REQUEUES=3
WORKER_JOB_HEARTBEAT_SECONDS=20
WORKER_REQUEUE_STALE_INTERVAL_SECONDS=15
WORKER_REQUEUE_STALE_PROCESSING_SECONDS=120

# Jina embedding throttling controls
JINA_ADAPTIVE_BATCHING_ENABLED=true
JINA_BATCH_MIN_SIZE=4
JINA_BATCH_RECOVERY_STEP=1

# Two-speed ingestion (searchable first, enrich later)
INGESTION_ENRICHMENT_ASYNC_ENABLED=true
INGESTION_VISUAL_ASYNC_ENABLED=true
STRICT_ENGINE_MAX_TOKENS=8192
METRICS_EMBEDDING_SPAN_MIN_MS=800
INGESTION_GRAPH_CHUNK_LOG_EVERY_N=25
ENRICHMENT_JOB_TIMEOUT_SECONDS=900

# Future local provider support (vLLM/Ollama)
LOCAL_MODEL_BASE_URL=http://localhost:8001/v1
LOCAL_MODEL_API_KEY=
